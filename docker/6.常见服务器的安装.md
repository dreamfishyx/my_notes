#### mysql

##### mysql容器配置

1. `docker pull mysql` 拉取最新版的 mysql 镜像。

2. 参考官方[文档](https://hub.docker.com/_/mysql)启动容器`docker run --name <container_name> -e MYSQL_ROOT_PASSWORD=<password> -d mysql:<tag>`，其中 `-e MYSQL_ROOT_PASSWORD`指定运行时的环境变量 MYSQL_ROOT_PASSWORD ，即 root 用户的密码。当然通过文档也可以知道还可以在创建容器时新增用户，即通过环境变量`-e MYSQL_USER=<user_name> \ -e MYSQL_PASSWORD=<user_password>`。

3. 然后就可以通过`docker exec -it <container_name> /bin/bash`进入容器中，并且使用 `mysql -uroot -p`使用密码登录。

4. 对于 mysql 镜像而言，其中存在以下几个重要位置：

   1. 数据文件位置：`/var/lib/mysql`。

      ```bash
      bash-5.1# ls -l /var/lib/mysql
      total 112528
      -rw-r----- 1 mysql mysql  6291456 Oct 12 10:47 '#ib_16384_0.dblwr'
      -rw-r----- 1 mysql mysql 14680064 Oct 12 10:45 '#ib_16384_1.dblwr'
      drwxr-x--- 2 mysql mysql     4096 Oct 12 10:45 '#innodb_redo'
      drwxr-x--- 2 mysql mysql     4096 Oct 12 10:45 '#innodb_temp'
      -rw-r----- 1 mysql mysql       56 Oct 12 10:45  auto.cnf
      -rw-r----- 1 mysql mysql  2943051 Oct 12 10:45  binlog.000001
      -rw-r----- 1 mysql mysql      158 Oct 12 10:45  binlog.000002
      -rw-r----- 1 mysql mysql       32 Oct 12 10:45  binlog.index
      -rw------- 1 mysql mysql     1705 Oct 12 10:45  ca-key.pem
      -rw-r--r-- 1 mysql mysql     1108 Oct 12 10:45  ca.pem
      -rw-r--r-- 1 mysql mysql     1108 Oct 12 10:45  client-cert.pem
      -rw------- 1 mysql mysql     1705 Oct 12 10:45  client-key.pem
      -rw-r----- 1 mysql mysql     5642 Oct 12 10:45  ib_buffer_pool
      -rw-r----- 1 mysql mysql 12582912 Oct 12 10:45  ibdata1
      -rw-r----- 1 mysql mysql 12582912 Oct 12 10:45  ibtmp1
      drwxr-x--- 2 mysql mysql     4096 Oct 12 10:45  mysql
      -rw-r----- 1 mysql mysql 32505856 Oct 12 10:45  mysql.ibd
      lrwxrwxrwx 1 mysql mysql       27 Oct 12 10:45  mysql.sock -> /var/run/mysqld/mysqld.sock
      -rw-r----- 1 mysql mysql      131 Oct 12 10:45  mysql_upgrade_history
      drwxr-x--- 2 mysql mysql     4096 Oct 12 10:45  performance_schema
      -rw------- 1 mysql mysql     1705 Oct 12 10:45  private_key.pem
      -rw-r--r-- 1 mysql mysql      452 Oct 12 10:45  public_key.pem
      -rw-r--r-- 1 mysql mysql     1108 Oct 12 10:45  server-cert.pem
      -rw------- 1 mysql mysql     1705 Oct 12 10:45  server-key.pem
      drwxr-x--- 2 mysql mysql     4096 Oct 12 10:45  sys
      -rw-r----- 1 mysql mysql 16777216 Oct 12 10:47  undo_001
      -rw-r----- 1 mysql mysql 16777216 Oct 12 10:47  undo_002
      
      bash-5.1# ls -l /var/lib/mysql/sys
      total 112
      -rw-r----- 1 mysql mysql 114688 Oct 12 10:45 sys_config.ibd
      ```

   2. 日志文件位置：`/var/log/mysql`。

   3. 配置文件位置：`/etc/mysql/`(使用较多的还是 `/etc/mysql/conf.d` 目录)。

5. 实际上，对于上述运行的容器，我们通过 `show variables like 'char%';` 查询，发现其字符编码并不全是我们期望的 utf8 或 utf8mb4 。

   ```bash
   mysql> show variables like 'char%';
   +--------------------------+--------------------------------+
   | Variable_name            | Value                          |
   +--------------------------+--------------------------------+
   | character_set_client     | latin1                         |
   | character_set_connection | latin1                         |
   | character_set_database   | utf8mb4                        |
   | character_set_filesystem | binary                         |
   | character_set_results    | latin1                         |
   | character_set_server     | utf8mb4                        |
   | character_set_system     | utf8mb3                        |
   | character_sets_dir       | /usr/share/mysql-9.0/charsets/ |
   +--------------------------+--------------------------------+
   8 rows in set (0.04 sec)
   ```

6. 此外，如果容器被不小心删除了，那么无论是数据文件、日志文件，还是设置字符编码的 my.cnf 文件，都将消失。在生产中，这是绝对不允许的，所以要保证数据的安全性。

> 关于 utf8 和 utf8mb4 :
>
> 1. utf8 和 utf8mb4 是两种字符集编码方式，它们之间的区别在于能够存储的字符范围和最大字节长度。
> 2.  utf8 是 MySQL 中最常用的字符集编码方式，它使用1到3个字节来存储字符。 utf8 能够存储大部分的中文汉字，但对于一些特殊的字符，如表情符号、一些较新的 Unicode 字符等， utf8 无法存储。
> 3. 而 utf8mb4 是 utf8 的超集，它使用1到4个字节来存储字符。 utf8mb4 可以存储任何 Unicode 字符，包括表情符号和一些较新的字符。因此，当需要存储这些特殊字符时，需要使用 utf8mb4 编码。
> 4. 在 MySQL 8.0 及更高版本中，utf8mb4 已成为默认字符集。对于新项目，特别是需要存储表情符号或其他特殊字符的项目，应该使用 utf8mb4 编码。需要注意的是，使用 utf8mb4 编码会占用更多的存储空间，因为它使用的字节长度更长。因此，在选择字符集编码时，需要根据实际需求和存储空间的考虑来决定使用 utf8 还是 utf8mb4 。





##### 补充

1. `general_log` (通用查询日志)是 MySQL 中的一种日志类型，用于记录所有发送到 MySQL 服务器的SQL查询(不论是否执行成功)。它可以帮助你调试和监控系统，跟踪数据库收到的每一个请求。在开发中可能用得上，记录一下。

2. 查看是否开启和开启：

   ```bash
   mysql> SHOW VARIABLES LIKE "general_log%";
   +------------------+---------------------------------+
   | Variable_name    | Value                           |
   +------------------+---------------------------------+
   | general_log      | OFF                             |
   | general_log_file | /var/lib/mysql/07bf4b52e83a.log |
   +------------------+---------------------------------+
   2 rows in set (0.01 sec)
   
   mysql> set global general_log=on;
   Query OK, 0 rows affected (0.02 sec)
   
   mysql> show variables like 'general_log%';
   +------------------+---------------------------------+
   | Variable_name    | Value                           |
   +------------------+---------------------------------+
   | general_log      | ON                              |
   | general_log_file | /var/lib/mysql/07bf4b52e83a.log |
   +------------------+---------------------------------+
   2 rows in set (0.01 sec)
   ```

   ```bash
   mysql> create database test;
   mysql> use test;
   mysql> create table  user(id int, name varchar(20), age int);
   mysql> insert into user values(1,'dreamfish',20);
   ```

   





##### 生产环境配置

1. 为了保证数据的安全性，在生产环境下安装的 mysql 容器，在启动时都会使用数据卷来持久化数据:

   ```bash
   docker run --name mysql_c \
   -e MYSQL_ROOT_PASSWORD=<password> \
   -v ~/mysql/data:/var/lib/mysql \
   -v ~/mysql/log:/var/log/mysql \
   -v ~/mysql/conf:/etc/mysql/conf.d \
   -dp 3306:3306 \
   mysql:<tag>
   ```

2. 解决字符编码的问题(尤其是 mysql5.x )，在宿主机的 `~/mysql/conf` 目录(这是配置文件对应的数据卷目录)中新建 my.cnf 文件，并在其中键入如下内容(当然其实也可以后面在容器中创建)：

   ```toml
   [client]
   default_character_set=utf8mb4
   
   [mysql]
   default_character_set=utf8mb4
   
   [mysqld]
   character_set_server=utf8mb4
   ```

3.  `docker restart mysql_c `重启容器并 `docker exec -it mysql /bin/bash` 进入容器，查看是否生效：

   ```bash
   mysql> show variables like 'character%';
   +--------------------------+--------------------------------+
   | Variable_name            | Value                          |
   +--------------------------+--------------------------------+
   | character_set_client     | utf8mb4                        |
   | character_set_connection | utf8mb4                        |
   | character_set_database   | utf8mb4                        |
   | character_set_filesystem | binary                         |
   | character_set_results    | utf8mb4                        |
   | character_set_server     | utf8mb4                        |
   | character_set_system     | utf8mb3                        |
   | character_sets_dir       | /usr/share/mysql-9.0/charsets/ |
   +--------------------------+--------------------------------+
   8 rows in set (0.01 sec)
   ```

   

   

   





##### 搭建mysql集群

1. 单机版的 MySQL 存在单点问题，且在高并发场景下性能会急剧下降。所以，生产中对于 MySQL 都是使用读写分离的主从集群。既保证了数据的安全性，又提升了性能。下面要使用 Docker 搭建一个“一主一从”的 MySQL 读写分离集群。

2. 首先我们需要创建一个 Docker 网络，使 MySQL 主库和从库能够在同一个网络中通信:`docker network create mysql-cluster-net`。

   > chatgpt推荐创建 Docker 网络(其实感觉基本上可以通过`--link`参数配置定向连接解决)：
   >
   > 1. **容器间通信便捷**： 当容器在同一个 Docker 网络中时，它们可以通过容器名称相互通信。例如，`mysql-slave` 可以通过容器名 `mysql-master` 来访问主库，而不需要通过 IP 地址。这极大地简化了配置。
   > 2. **避免使用动态 IP**： Docker 分配给容器的 IP 地址可能会变化。使用容器名称而不是硬编码的 IP 地址可以确保容器即使重新启动后也能保持连接，避免 IP 地址的管理问题。
   > 3. **网络隔离和安全性**： Docker 网络可以为容器提供额外的隔离。通过创建一个专用的网络（如 `mysql-cluster-net`），可以确保你的 MySQL 主从实例与外部服务隔离，防止非预期访问和数据泄露。
   > 4. **简化主从复制配置**： 在主从配置时，你需要指定 `MASTER_HOST`，如果没有 Docker 网络，你必须使用主库的 IP 地址。而通过 Docker 网络，主库和从库可以通过名称互相访问，简化了配置。

3. 启动主库容器拉取并启动 MySQL 主库容器，并配置好主库的必要参数。

   ```bash
   docker run --name mysql-master \
     --network mysql-cluster-net \
     -e MYSQL_ROOT_PASSWORD=<password> \
     -v ~/mysql/master/log:/var/log/mysql \
     -v ~/mysql/master/conf:/etc/mysql/conf.d \
     -v ~/mysql/master/data:/var/lib/mysql \
     -dp 3316:3306 \
     mysql:<tag>
   ```

4. 编辑主库的配置文件 `my.cnf`(位于 `~/mysql/master/conf/my.cnf`），配置以下内容：

   ```toml
   [client]
   default_character_set=utf8
   [mysql]
   default_character_set=utf8
   [mysqld]
   character_set_server=utf8
   
   
   server_id=01			
   binlog-ignore-db=mysql   
   log-bin=master-log-bin
   binlog_cache_size=1M
   binlog_format=mixed
   expire_logs_days=7
   slave_skip_errors=1062
   #binlog-do-db=mydb  
   ```

5. 由于修改了 mysql 配置，所以需要重启 master 容器，以使新配置生效：`docker restart mysql-master `。

6. 接着，启动 MySQL 从库容器，并配置好从库的相关参数。

   ```bash
   docker run --name mysql-slave \
     --network mysql-cluster-net \
     -e MYSQL_ROOT_PASSWORD=<password> \
     -v ~/mysql/slave/log:/var/log/mysql \
     -v ~/mysql/slave/conf:/etc/mysql/conf.d \
     -v ~/mysql/slave/data:/var/lib/mysql \
     -dp 3326:3306 \
     mysql:<tag>
   ```

7. 编辑从库的配置文件 `my.cnf`(位于`~/mysql/slave/conf/my.cnf`)，确保包含以下内容：

   ```toml
   [client]
   default_character_set=utf8
   [mysql]
   default_character_set=utf8
   [mysqld]
   character_set_server=utf8
    
   server_id=02
   binlog-ignore-db=mysql
   log-bin=slave-log-bin
   binlog_cache_size=1M
   binlog_format=mixed
   expire_logs_days=7
   slave_skip_errors=1062
   
   relay_log=relay-log-bin
   log_slave_updates=1
   read_only=1   # 确保从库是只读的
   # super_read_only=1
   ```

8. 完成配置后，重启从库容器：`docker restart mysql-slave`

9. 在主库( mysql-master )上创建复制用户:进入主库容器，创建用于主从复制的用户并赋予它权限。

   ```bash
   docker exec -it mysql-master mysql -uroot -p
   
   create user 'slave'@'%' identified by '<password>';
   grant replication slave , replication client on *.* to 'slave'@'%';
   flush privileges;
   ```

   > 1. `grant replication slave, replication client`：授予用户 `slave` 两个复制相关的权限：
   >    - `replication slave`：允许该用户读取二进制日志（用于复制）。
   >    - `replication client`：允许该用户执行查看复制状态的命令，如 `SHOW SLAVE STATUS`。
   > 2. `on *.*  to 'slave'@'%'`：其中`on *.* `表示这些权限适用于所有数据库和所有表。`to 'slave'@'%'`表明授予这些权限给 `slave` 用户，`'%'` 表示该用户可以从任意 IP 地址访问。
   > 3. `flush privileges`：刷新 MySQL 的权限表，使得新创建的用户和权限更改立即生效。

10. 执行以下命令来获取当前二进制日志文件的名称和位置，这些信息将用于配置从库：`show master status;`(<font color=red>在mysql8.x中命令更改为</font>`show replica status;`)，记下 `File` 和 `Position` 的值（如 `mysql-bin.000001` 和 `120`）。

11. 进入从库( mysql-slave )容器，设置从库复制：`docker exec -it mysql-slave mysql -uroot -p`

12. 在从库的 MySQL 命令行中，使用主库的 IP 地址、日志文件和位置配置复制：

    ```bash
    CHANGE MASTER TO
      MASTER_HOST='mysql-master', 				-- 也可以配置ip(若是使用bridge网络，可以使用参数--link实现定向连接)
      MASTER_USER='slave',						-- 用户名
      MASTER_PASSWORD='slave_password',    		-- 密码
      MASTER_PORT=3316,					   		-- 主库端口
      MASTER_LOG_FILE='master-log-bin.000001', 	-- 从主库获取的文件名
      MASTER_LOG_POS=120,                  		-- 从主库获取的位置
      MASTER_CONNECT_RETY=30,					-- 重新尝试连接时间间隔
      MASTER_RETRY_COUNT=3;						-- 尝试连接次数
    
    
    -- 开启同步
    START SLAVE;
    ```

13. 查看从库的状态，以确保配置成功：`SHOW SLAVE STATUS\G;`,确保 `Slave_IO_Running` 和 `Slave_SQL_Running` 均为 `Yes`。

14. 此外后面也可以尝试使用 docker-compose 搭建 mysql 主从集群。





##### 说明

1. 主库配置文件常用配置：

   ```toml
   [client]
   default_character_set=utf8
   [mysql]
   default_character_set=utf8
   [mysqld]
   character_set_server=utf8
   
   
   server_id=01			
   binlog-ignore-db=mysql   
   log-bin=master-log-bin
   binlog_cache_size=1M
   binlog_format=mixed
   expire_logs_days=7
   slave_skip_errors=1062
   binlog-do-db=mydb
   
   max_connections = 200
   auto_increment_increment = 2
   auto_increment_offset = 1  
   innodb_flush_log_at_trx_commit = 1  
   sync_binlog = 1 
   ```

2. 关于主库配置文件的介绍：

   1. `erver_id`定义 MySQL 服务器的唯一标识符。在主从复制环境中，每个服务器必须有一个唯一的 `server_id`，以便于区分不同的服务器。
   2. `binlog-ignore-db`：用于指定不记录到二进制日志的数据库。此处 mysql 数据库不会被记录到二进制日志中，因此从库不会复制该数据库中的操作。
   3. `log-bin`：启用二进制日志记录，并将二进制日志文件命名为 `master-log-bin`。二进制日志用于记录所有写操作(INSERT、UPDATE、DELETE等)，这些日志可以用于从库同步和数据恢复。
   4. `binlog_cache_size`：设置二进制日志缓存的大小。如果一个事务在写入二进制日志时生成的数据超过了这个大小，MySQL 会将日志写入磁盘。较大的值可以提升性能，特别是在执行大事务时。
   5. `binlog_format`：定义二进制日志的格式，有三种可选格式：
      - `STATEMENT`：基于语句的日志记录，每个 SQL 语句都会被记录。
      - `ROW`：基于行的日志记录，记录每行数据的具体更改。
      - `MIXED`：混合模式，通常使用基于语句的日志，但在某些需要更高精度的情况下(如存储过程)会自动切换到基于行的日志。`MIXED` 提供了较好的兼容性和性能平衡。
   6. `expire_logs_days`：设置二进制日志的保留天数。这里设置为 7 天，表示二进制日志文件超过 7 天后将被自动删除，避免日志占用过多的磁盘空间。
   7. `slave_skip_errors`：设置从库在同步时跳过特定错误，这里跳过的是错误代码 `1062`，即重复键错误（Duplicate Entry）。在某些情况下，可能主从库之间的数据不完全一致，使用该配置可以让从库跳过重复键错误，继续执行同步。但需要谨慎使用，以避免数据不同步的问题。
   8. `binlog-do-db`：指定二进制日志只记录特定数据库的更改。在此配置下，只有 `mydb` 数据库的操作会被记录到二进制日志中，从而被从库复制。如果要记录多个数据库的更改，可以多次使用此选项。
   9. `max_connections` 参数定义 MySQL 允许的最大并发客户端连接数。在这里设置为 `200`，表示主库可以同时处理 200 个客户端连接。
   10. `auto_increment_increment` 定义了自增字段的步长(增量)，即每次生成自增值时，数值增大的幅度。这里设置为 `2`。在主从复制环境下，多个服务器可能同时进行写操作，而自增字段（如 `AUTO_INCREMENT` 主键）可能会发生冲突。通过设置不同的 `auto_increment_increment` 和 `auto_increment_offset` 值，可以避免这种冲突。
   11. `auto_increment_offset` 定义自增字段的起始值偏移量。在主库中设置为 `1`，表示主库从 1 开始生成自增主键值。
   12. `innodb_flush_log_at_trx_commit` 控制 InnoDB 如何将事务日志（redo log）写入磁盘。其值为 `1` 表示每次事务提交时，InnoDB 都会将日志立即写入磁盘并进行同步（即物理写盘）。
   13. `sync_binlog` 控制 MySQL 二进制日志（binlog）写入磁盘的同步频率。值为 `1` 表示每次事务提交后，二进制日志都会被同步到磁盘。

3. 从库配置文件常用配置：

   ```toml
   [client]
   default_character_set=utf8
   [mysql]
   default_character_set=utf8
   [mysqld]
   character_set_server=utf8
    
   # 作为主库的一些配置
   server_id=02
   binlog-ignore-db=mysql
   log-bin=slave-log-bin
   binlog_cache_size=1M
   binlog_format=mixed
   expire_logs_days=7
   slave_skip_errors=1062
   # ...
   
   # 作为从库的一些配置
   relay_log=relay-log-bin
   log_slave_updates=1
   read_only=1   # 确保从库是只读的
   super_read_only=1
   auto_increment_increment = 2
   auto_increment_offset = 2 
   max_connections = 100
   replicate-do-db = mydb  
   replicate-ignore-db = test_db
   innodb_buffer_pool_size = 512M
   relay_log_purge = 1
   ```

4. 关于从库配置文件的介绍：

   1. 首先需要说明一点，从库也可以作为其它从库的主库，故而是可以配置主库的一些配置。此外作为从库，它也存在一些自己的配置。
   2. `relay_log`：启用从库的中继日志。中继日志记录从主库接收到的二进制日志事件，从库使用这些日志来执行相同的更改。中继日志文件的前缀为       relay-log-bin 。
   3. `log_slave_updates`：确保从库将自己接收到的更改写入二进制日志。这个配置对多级复制（链式复制）至关重要。如果启用此选项，从库会将自己从主库接收到的更改记录到二进制日志，从而允许其他从库继续复制。
   4. `read_only`：将从库设置为只读，防止直接修改数据库中的数据。这个设置确保了从库仅作为读取数据的副本存在，不能在从库上执行写入操作。
   5. `super_read_only：与 `read_only` 相似，但更加严格。即使是具有超级用户权限的账户也无法在从库上执行写操作。这个设置确保从库不会在任何情况下发生写操作，进一步加强了数据的一致性。
   6. `auto_increment_increment 和 `auto_increment_offset：这些设置用于在多主环境或主从复制中防止自增主键冲突。
   7. `max_connections`：限制 MySQL 允许的最大连接数。在这个配置中，最多允许 100 个客户端连接到数据库。这个设置用于控制并发连接的数量，避免过多的连接消耗过多的系统资源。
   8. `replicate-do-db`和 `replicate-ignore-db`：这些配置控制从库应该复制哪些数据库的数据。
      - `replicate-do-db=mydb`：仅复制 `mydb` 数据库的内容。
      - `replicate-ignore-db=test_db`：忽略 `test_db` 数据库的内容，不将其复制到从库。
   9. `relay_log_purge`：设置是否自动清除过期的中继日志。启用此选项（`1`）时，MySQL 会自动删除已经应用过的中继日志文件。这样可以节省磁盘空间。

5. 关于只读从库：`read_only=1`可以将从库设置为只读，防止直接修改数据库中的数据。但是改配置对于具有超级用户权限的账户是无效的；并且一般也不建议使用`super_read_only=1`。









```
docker volume create 待补 https://www.cnblogs.com/goloving/p/15087746.html
```



![image-20241012154416060](./assets/image-20241012154416060.png)



![image-20241012154727597](./assets/image-20241012154727597.png)

#### redis

学完redis7再补充(109集)
